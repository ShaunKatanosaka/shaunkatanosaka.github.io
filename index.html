<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Blackjack Simulator</title>
    <style>
        body {
            font-family: monospace;
            background: #222;
            color: #eee;
            padding: 20px;
        }

        pre {
            background: #111;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }

        button {
            background: #28a745;
            border: none;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 15px;
        }

            button:hover {
                background: #218838;
            }
    </style>
</head>

<body>
    <h1>Blackjack Risk of Ruin Simulator</h1>
    <label for="sessionInput">Number of Sessions:</label>
    <input type="number" id="sessionInput" value="100" min="1" style="width:80px;">

    <label for="shoesInput" style="margin-left:20px;">Shoes per Session:</label>
    <input type="number" id="shoesInput" value="10" min="1" style="width:80px;">

    <label for="displayHandCheckbox" style="margin-left:20px;">Display Hands:</label>
    <input type="checkbox" id="displayHandCheckbox" style="width:80px;">

    <button onclick="runSimulation()">Run Simulation</button>

    <pre id="display"></pre>

    <pre id="output"></pre>

    <input type="text" id="userInput" placeholder="Type here">
    <button onclick="readInput()">Submit</button>
    <script>
        function readInput() {
            let value = document.getElementById('userInput').value;
            console.log("You entered:", value);
        }

    </script>

    <script>
        // ----- Suit Symbols -----
        const suitSymbols = { S: "♠", H: "♥", D: "♦", C: "♣" };
        // Blackjack Risk of Ruin Simulator (JavaScript translation)
        // Note: This translation assumes CSV strategy tables are loaded as JS objects.
        // You will need to implement CSV parsing or hardcode the tables for a working version.

        class Card {
            constructor(rank, suit) {
                this.rank = rank;
                this.suit = suit;
                this.value = this.getValue();
            }

            toString() {
                const suitSymbols = { S: '♠', H: '♥', D: '♦', C: '♣' };
                return `${this.rank}${suitSymbols[this.suit]}`;
            }

            getValue() {
                if (['J', 'Q', 'K'].includes(this.rank)) return 10;
                if (this.rank === 'A') return 1; // handle later as 1 or 11
                return parseInt(this.rank, 10);
            }
        }

        class Deck {
            constructor(numDecks = 6) {
                this.cards = this.buildDeck(numDecks);
                this.shuffle();
            }

            getCardsLeft() {
                return this.cards.length;
            }

            buildDeck(numDecks) {
                const ranks = [...Array(8).keys()].map(n => (n + 2).toString()).concat(['10', 'J', 'Q', 'K', 'A']);
                const suits = ['H', 'D', 'C', 'S'];
                let deck = [];
                for (let d = 0; d < numDecks; d++) {
                    for (let rank of ranks) {
                        for (let suit of suits) {
                            deck.push(new Card(rank, suit));
                        }
                    }
                }
                return deck;
            }

            shuffle() {
                for (let i = this.cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
                }
            }

            dealCard() {
                return this.cards.pop();
            }

            getCount() {
                let count = 0;
                for (let card of this.cards) {
                    if (card.value >= 2 && card.value <= 6) count += 1;
                    else if (card.value >= 7 && card.value <= 9) count += 0;
                    else if (card.value === 10 || card.rank === "A") count -= 1;
                }
                return -count;
            }
        }

        class Hand {
            constructor(inputBet = 25) {
                this.cards = [];
                this.softTotal = false;
                this.bet = inputBet;
                this.betMultiplier = 1;
            }

            addCard(card) {
                this.cards.push(card);
            }

            clearHand() {
                this.cards = [];
            }

            containsAce() {
                return this.cards.some(card => card.rank === 'A');
            }

            getValues() {
                let total = this.cards.reduce((sum, card) => sum + card.value, 0);
                let aces = this.cards.filter(card => card.rank === 'A').length;
                if (total <= 11 && aces) {
                    this.softTotal = true;
                    total += 10;
                } else {
                    this.softTotal = false;
                }
                return total;
            }
            printValues() {
                console.log(this.getValues());
            }

            displayHand() {
                const handList = this.cards.map(card => card.toString());
                console.log(handList);
            }

            displayOneHand() {
                if (this.cards.length > 0) {
                    console.log(this.cards[0].toString());
                } else {
                    console.log("No cards in hand.");
                }
            }
        }

        class GameSimulator {
            constructor(numDecks = 2, autoPlayInput = false, bankroll = 1000, cutCardSpot = 0.75) {
                this.numberOfDecks = numDecks;
                this.deck = new Deck(this.numberOfDecks);
                this.bankroll = bankroll;
                this.initialBankroll = bankroll;
                this.cutCardSpot = cutCardSpot;
                this.bankrollProgress = [];
                this.totalWagered = 0;
                this.displayMode = true;
                this.handsPlayed = 0;
                this.numberOfPlayers = 1;
                this.initialNumberOfPlayers = this.numberOfPlayers;
                this.autoPlay = autoPlayInput;
                this.shoesPlayed = 1;
                this.handsPlayedInShoe = 0;
            }

            displayHands(players, dealer) {
                if (this.displayMode) {
                    dealer.displayOneHand();
                    console.log("\n");
                    for (let i = 0; i < this.numberOfPlayers; i++) {
                        players[i].displayHand();
                        players[i].printValues();
                    }
                }
            }

            displayAllHands(players, dealer) {
                if (this.displayMode) {
                    dealer.displayHand();
                    dealer.printValues();
                    console.log("\n");
                    for (let i = 0; i < this.numberOfPlayers; i++) {
                        players[i].displayHand();
                        players[i].printValues();
                    }
                }
            }

            playHand(betInput = 25, hardTotals, softTotals, splits, splitDict) {
                const cardsCut = this.cutCardSpot * 52 * this.numberOfDecks;
                let bet = betInput;
                let players = [];
                for (let i = 0; i < this.numberOfPlayers; i++) {
                    players.push(new Hand(bet));
                }
                let dealer = new Hand();

                this.handsPlayed += 1;

                if (this.deck.getCardsLeft() <= cardsCut) {
                    this.deck = new Deck(this.numberOfDecks);
                    this.shoesPlayed += 1;
                    this.handsPlayedInShoe = 0;
                    if (this.displayMode) {
                        console.log("new shoe");
                    }
                }

                // Deal cards
                if (this.deck.getCardsLeft() > cardsCut) {
                    for (let i = 0; i < this.numberOfPlayers; i++) {
                        players[i].addCard(this.deck.dealCard());
                    }
                    dealer.addCard(this.deck.dealCard());
                    for (let i = 0; i < this.numberOfPlayers; i++) {
                        players[i].addCard(this.deck.dealCard());
                    }
                    dealer.addCard(this.deck.dealCard());
                    this.handsPlayedInShoe += 1;
                }

                let handsTotal = this.numberOfPlayers;
                let dealerBlackjack = false;
                let i = 0;
                let handOver = false;
                while (i < handsTotal) {
                    if (dealer.getValues() === 21) {
                        handOver = true;
                        if (this.displayMode) {
                            console.log("dealer blackjack");
                        }
                        dealerBlackjack = true;
                    }

                    if (players[i].getValues() === 21) {
                        handOver = true;
                        if (this.displayMode) {
                            console.log("player blackjack");
                        }
                        if (!dealerBlackjack) {
                            players[i].betMultiplier = 1.5;
                        }
                    }

                    if (players[i].cards.length === 1) {
                        players[i].addCard(this.deck.dealCard());
                    }
                    if (this.displayMode) {
                        if (handOver) {
                            this.displayAllHands(players, dealer);
                        } else {
                            this.displayHands(players, dealer);
                        }
                        console.log(`wager: $${players[i].bet}`);
                    }
                    while (!handOver) {
                        let x = '';
                        if (!this.autoPlay) {
                            // Manual input not supported in JS simulation
                            x = prompt();
                        } else {
                            players[i].getValues(); // update softTotal
                            let dealerUpcard = dealer.cards[0].rank;
                            if (["J", "Q", "K"].includes(dealerUpcard)) dealerUpcard = "10";
                            if (players[i].cards[0].value === players[i].cards[1].value && players[i].cards.length === 2) {
                                let YorN = splits[dealerUpcard][players[i].cards[0].value.toString().repeat(2)];
                                if (YorN === "Y") x = 'p';
                            }
                            if (players[i].softTotal && x === '') {
                                if (players[i].getValues() === 21) {
                                    x = 's';
                                } else {
                                    // You may need to adjust playerTotal for softTotals lookup
                                    let playerTotal = "A" + (players[i].getValues() - 11);
                                    x = softTotals[dealerUpcard][playerTotal];
                                }
                            } else if (x === '') {
                                if (players[i].getValues() >= 17 && players[i].getValues() <= 21) x = 's';
                                else if (players[i].getValues() <= 7) x = 'h';
                                else x = hardTotals[dealerUpcard][players[i].getValues().toString()];
                            }
                            if (x === 'ds' && players[i].cards.length !== 2) x = 's';
                            else if (x === 'ds') x = 'd';
                            if (x === 'd' && players[i].cards.length !== 2) x = 'h';
                        }
                        if (this.displayMode) {
                            console.log("auto choose", x);
                        }

                        // stand split hit double surrender
                        if (x === 'h') {
                            players[i].addCard(this.deck.dealCard());
                        } else if (x === 's') {
                            break;
                        } else if (x === 'p') {
                            let tempCard1 = players[i].cards[0];
                            let tempCard2 = players[i].cards[1];
                            players.splice(i + 1, 0, new Hand());
                            players[i + 1].addCard(tempCard2);
                            players[i].clearHand();
                            players[i].addCard(tempCard1);

                            if (players[i].cards[0].rank === 'A') {
                                players[i].addCard(this.deck.dealCard());
                                players[i + 1].addCard(this.deck.dealCard());
                                i += 1;
                                handsTotal += 1;
                                this.numberOfPlayers += 1;
                                break;
                            } else {
                                players[i].addCard(this.deck.dealCard());
                                handsTotal += 1;
                                this.numberOfPlayers += 1;
                            }
                        } else if (x === 'd') {
                            players[i].addCard(this.deck.dealCard());
                            players[i].bet *= 2;
                            break;
                        } else {
                            console.log("bad input. smth wrong");
                        }
                        if (players[i].getValues() > 21) {
                            if (this.displayMode) {
                                console.log("player bust");
                            }
                            handOver = true;
                            this.displayAllHands(players, dealer);
                            break;
                        } else if (players[i].getValues() === 21) {
                            if (this.displayMode) {
                                console.log("player 21");
                            }
                            break;
                        }
                        this.displayHands(players, dealer);
                    }
                    i += 1;
                }
                while (!handOver) {
                    if (dealer.getValues() <= 16) {
                        dealer.addCard(this.deck.dealCard());
                    } else if (dealer.getValues() === 17 && dealer.softTotal) {
                        dealer.addCard(this.deck.dealCard());
                    } else {
                        handOver = true;
                        this.displayAllHands(players, dealer);
                    }
                }
                for (let i = 0; i < handsTotal; i++) {
                    if (players[i].getValues() > 21) {
                        if (this.displayMode) {
                            console.log("player loses");
                        }
                        this.bankroll -= players[i].bet * players[i].betMultiplier;
                        this.totalWagered += players[i].bet * players[i].betMultiplier;
                    } else if (dealer.getValues() > 21) {
                        if (this.displayMode) {
                            console.log("dealer bust");
                            console.log("player wins");
                        }
                        this.bankroll += players[i].bet * players[i].betMultiplier;
                        this.totalWagered += players[i].bet * players[i].betMultiplier;
                    } else if (players[i].getValues() === dealer.getValues()) {
                        if (this.displayMode) {
                            console.log("push");
                        }
                    } else if (players[i].getValues() > dealer.getValues()) {
                        if (this.displayMode) {
                            console.log("player wins");
                        }
                        this.bankroll += players[i].bet * players[i].betMultiplier;
                        if (players[i].betMultiplier === 1.5) {
                            this.totalWagered += players[i].bet;
                        } else {
                            this.totalWagered += players[i].bet * players[i].betMultiplier;
                        }
                    } else {
                        if (this.displayMode) {
                            console.log("player loses");
                        }
                        this.bankroll -= players[i].bet * players[i].betMultiplier;
                        this.totalWagered += players[i].bet * players[i].betMultiplier;
                    }
                    if (this.displayMode) {
                        console.log('\n');
                    }
                }
                this.numberOfPlayers = this.initialNumberOfPlayers;
            }
        }




        const hardTotalsCSV = `
Player Total,2,3,4,5,6,7,8,9,10,A
17,s,s,s,s,s,s,s,s,s,s
16,s,s,s,s,s,h,h,h,h,h
15,s,s,s,s,s,h,h,h,h,h
14,s,s,s,s,s,h,h,h,h,h
13,s,s,s,s,s,h,h,h,h,h
12,h,h,s,s,s,h,h,h,h,h
11,d,d,d,d,d,d,d,d,d,d
10,d,d,d,d,d,d,d,d,h,h
9,h,d,d,d,d,h,h,h,h,h
8,h,h,h,h,h,h,h,h,h,h
`;

        const softTotalsCSV = `
Player hand,2,3,4,5,6,7,8,9,10,A
A9,s,s,s,s,s,s,s,s,s,s
A8,s,s,s,s,ds,s,s,s,s,s
A7,ds,ds,ds,ds,ds,s,s,h,h,h
A6,h,d,d,d,d,h,h,h,h,h
A5,h,h,d,d,d,h,h,h,h,h
A4,h,h,d,d,d,h,h,h,h,h
A3,h,h,h,d,d,h,h,h,h,h
A2,h,h,h,d,d,h,h,h,h,h
`;

        const splitsCSV = `
Pair,2,3,4,5,6,7,8,9,10,A
11,Y,Y,Y,Y,Y,Y,Y,Y,Y,Y
1010,N,N,N,N,N,N,N,N,N,N
99,Y,Y,Y,Y,Y,N,Y,Y,N,N
88,Y,Y,Y,Y,Y,Y,Y,Y,Y,Y
77,Y,Y,Y,Y,Y,Y,N,N,N,N
66,Y,Y,Y,Y,Y,N,N,N,N,N
55,N,N,N,N,N,N,N,N,N,N
44,N,N,N,Y,Y,N,N,N,N,N
33,Y,Y,Y,Y,Y,N,N,N,N,N
22,Y,Y,Y,Y,Y,N,N,N,N,N
`;

        // --- CSV Parsing Functions ---
        function parseSoftTotalsCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').slice(1); // Dealer upcards
            const obj = {};
            for (let h of headers) obj[h] = {}; // Initialize dealer upcard keys

            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',');
                const playerTotal = cols[0].replace(/\s/g, ''); // e.g., "A9"
                for (let j = 1; j < cols.length; j++) {
                    const dealerUpcard = headers[j - 1];
                    obj[dealerUpcard][playerTotal] = cols[j];
                }
            }
            return obj;
        }

        // --- Use the new parser for softTotals ---
        const softTotals = parseSoftTotalsCSV(softTotalsCSV);
        const hardTotals = parseSoftTotalsCSV(hardTotalsCSV);
        const splits = parseSoftTotalsCSV(splitsCSV);
        // --- Split Dictionary (already provided) ---
        const splitDict = {
            "A": 0, "K": 1, "Q": 1, "J": 1, "10": 1,
            "9": 2, "8": 3, "7": 4, "6": 5, "5": 6,
            "4": 7, "3": 8, "2": 9
        };

        let test = new Deck(1);

        // --- Simulation Runner ---
        function runSimulation() {
            // Get user input for number of sessions
            let numberOfSessions = parseInt(document.getElementById('sessionInput').value, 10) || 100;
            let shoesToPlay = parseInt(document.getElementById('shoesInput').value, 10) || 100;

            // --- CSV Data as Strings ---


            let timesGoneBroke = 0;
            let finalProfit = [];
            let handsPlayed = [];
            for (let simNum = 0; simNum < numberOfSessions; simNum++) {
                let sim = new GameSimulator(2, true, 500, 0.25);
                sim.displayMode = document.getElementById('displayHandCheckbox').checked;
                let goneBroke = false;;
                const bettingStrategy = {
                    0: 25, 1: 25, 2: 25, 3: 25, 4: 25, 5: 25
                };

                while (sim.shoesPlayed <= shoesToPlay) {
                    let runningCount = sim.deck.getCount();
                    let decksRemaining = sim.deck.getCardsLeft() / 52;
                    let trueCount = decksRemaining === 0 ? 0 : Math.floor(runningCount / decksRemaining);

                    function getBetFromTrueCount(tc) {
                        if (tc <= 0) return bettingStrategy[0];
                        if (tc >= 5) return bettingStrategy[5];
                        return bettingStrategy[tc] || 25;
                    }

                    sim.playHand(getBetFromTrueCount(trueCount), hardTotals, softTotals, splits, splitDict);
                    if (sim.displayMode) {
                        console.log(`Bankroll: $${sim.bankroll}, True Count: ${trueCount}`);
                    }
                    if (sim.bankroll < 0 && !goneBroke) {
                        timesGoneBroke += 1;
                        goneBroke = true;
                    }
                }
                let houseEdge = -(sim.bankroll - sim.initialBankroll) / sim.totalWagered * 100;

                console.log(`Final Bankroll: $${sim.bankroll}`);
                console.log(`House Edge: ${houseEdge.toFixed(2)}%`);

                handsPlayed.push(sim.handsPlayed);
                finalProfit.push(sim.bankroll - sim.initialBankroll);
            }

            finalProfit.sort((a, b) => a - b);
            let output = "";
            output += "----- Simulation Results -----\n";
            output += "number of sessions: " + numberOfSessions + "\n";
            output += "total shoes played: " + (numberOfSessions * shoesToPlay) + "\n";
            output += "times gone broke: " + timesGoneBroke + "\n";
            output += "average profit: $" + (finalProfit.reduce((a, b) => a + b, 0) / finalProfit.length) + "\n";
            output += "worst result: $" + finalProfit[0] + "\n";
            output += "10% bottom result: $" + finalProfit[Math.floor(finalProfit.length / 10)] + "\n";
            output += "best result: $" + finalProfit[finalProfit.length - 1] + "\n";
            output += "10% top result: $" + finalProfit[Math.floor(finalProfit.length / 10 * 9)] + "\n";
            output += "average hands played per session: " + (handsPlayed.reduce((a, b) => a + b, 0) / handsPlayed.length) + "\n";

            document.getElementById("output").textContent = output;
        }
    </script>


</body>
</html>
